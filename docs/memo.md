# アイテム追加の手順

1. item.dat.js の ItemObjNew に新しいアイテムデータを追加する
    このとき追加したデータをドロップダウンに表示するため g_ItemIdArrayByKind に itemID を追加する必要がある

2. エンチャントがある場合は mig.enchlist.dat.js の sourceArray に新しいエンチャントリストを追加する

3. mig.enchlist.dat.js の reverseResolveArrayItemId にエンチャントリストの主キーを追加する
    この配列は itemId を引数にとり、該当する配列インデックスにあるエンチャント情報の主キーを返すために使われる
    例えば itemId=4994 のエンチャントを指定する場合は、配列の 4995 番目に該当する主キーをセットする必要がある

4. セット効果がある場合は itemset.dat.js に新しいリレーションを追加する
    このとき、もし初めて登場したセット効果ならば item.dat.js にセット効果を追加しておく必要がある

# 解析メモ

## equip.js -> OnChangeEquip(eqpRgnId, itemId)

RebuildCardSelect(eqpRgnId, itemId) でアイテムごとに異なるエンチャントがセットされる
その後 SetCardSlotEnability() でエンチャントの中身をチェックして、表示すべき情報が存在しなければ非表示にする

## hmcard.js -> RebuildCardSelect(eqpRgnId, itemId)

例えば itemId = 4992 を渡すと次の処理は enchListIdArray = [617] を返す
```
var enchListDataManager = g_constDataManager.GetDataManger(CONST_DATA_KIND_ENCHANT_LIST);
var enchListIdArray = enchListDataManager.GetEnchListIdArrayByItemId(itemId);
```

その後 enchListId = 617 を渡すと次の処理は 617 を主キーとした 3 つのエンチャリストを返す
```
enchInfoArrayAllSlots = RebuildCardSelectSubCollectEnchListData(enchListId, enchInfoArrayAllSlotsResult);
```

例えば 暴走魔力（精錬値10以上）は次の配列で定義される
```
[617, 888, [10, 4], 277]
```

解析結果によると
```
617 = 主キー
888 = 暴走魔力
10, 4 = 精錬値10以上
```
を示している

## mig.enchlist.dat.js

エンチャントを定義するためには 2 箇所の記述が必要になる
どちらか片方でも不備があれば計算機はエンチャントが存在しない装備であると判断する

- g_constDataManager.enchListDataManager.sourceArray 

装備スロットとエンチャントのリレーション定義
```
[
    617,-1,0,0,                                                                 # 主キー = 617
    [["スペシャルエンチャント（オーブ）","C3y4C2h1I3A4J5D2h1J5D5A5A5f3"]],         # エンチャント種別, ハッシュ
    [],
    [[
        [174,[50,[4992]]],,                                                     # itemID = 4992
        [
            [
                [178,[27,[4]]],,                                                             # slot4
                [[
                    [187,[59,8],[60,4]],                                                     # 精錬値8以上のエンチャント
                    ,
                    [[[186,[51,[1848,1655,1656,1657,1658,1659,1660,1661,1662,1663]]],,[]]]   # エンチャントの cardID を配列で指定
                ]]
            ],
            [
                [178,[27,[3]]],,                                                # slot3
                [[
                    [187,[59,9],[60,4]],                                        # 精錬値9以上のエンチャント
                    ,
                    [[[186,[51,[2311]]],,[]]]                                   # cardID 配列
                ]]
            ],
            [
                [178,[27,[2]]],,                                                # slot2
                [[
                    [187,[59,10],[60,4]],                                       # 精錬値10以上のエンチャント
                    ,
                    [[[186,[51,[1297,888,1303,1348,1245]]],,[]]]                # cardID 配列
                ]]
            ]
        ]
    ]],
    []
],
```

- g_constDataManager.enchListDataManager.reverseResolveArrayItemId

itemId からエンチャント情報を引き出すためのインデックス
例えば itemId = 4992 に関連するエンチャント情報の主キーは reverseResolveArrayItemId 配列の 4993 番目に格納する必要がある

## card.dat.js

エンチャントのマスタは card.dat.js で定義されている

```
[
    888,                                                                                                　# 主キー
    99,                                                                                                   # 1～7 はカード部位, 99 はエンチャント, 100 は装備固有の効果
    "暴走した魔力",                                                                                        # 名称テキスト
    "魔法攻撃命中時、一定確率で10秒間、[暴走した魔力]発動<BR>[暴走した魔力]発動時、Int + 200、1秒毎にSP - 200",  # 効果テキスト
    0
],

[
    2311,
    99,
    "異境の統轄者","",
    17,50,              # ATK +50
    100,50,             # Matk +50
    0
],
```



## item.dat.js

装備のマスタは item.dat.js で定義されている

セット効果には個別のアイテムIDが割り当てられており、条件を満たしたときにセット効果が適用される
例えば itemID = 4992 セトの恩寵には異境のセット効果で固定詠唱-70%が付くがこれは itemID = 4993 である

```
[
    4992,           # itemID = 4992
    60,             # 60 = 鎧
    0,
    150,            # DEF = 150
    0,
    1,              # Slot = 1
    100,            # 重量 = 100
    90,             # Lv制限 = 90
    "セトの恩寵","セトノオンチヨウ","",
    19,15,          # MDEF = 15
    194,1,          # 損傷しない
    12,10,          # ASPD +10%
    30,40,          # 無形物理 +40%
    37,40,          # 人間物理 +40%
    272,40,         # ドラム物理 + 40%
    47,40,          # 闇属性物理 + 40%
    40,40,          # 無属性物理 + 40%
    170,40,         # 無形魔法 +40%
    177,40,         # 人間魔法 +40%
    273,40,         # ドラム魔法 + 40%
    357,40,         # 闇属性魔法 + 40%
    350,40,         # 無属性魔法 + 40%
    100066,2,       # 精錬1あたり聖属性耐性 +2%
    5000018,300,    # 精錬5のときDEF +300
    5000019,30,     # 精錬5のときMDEF +30
    5000243,7,      # 精錬7のときP耐 +7%
    7000074,15,     # 精錬7のときディレイ -15%
    0
],

[
    4993,                   # itemID = 4993
    100,                    # 100 = 装備固有の効果
    0,0,0,0,0,0,0,0,
    "固定詠唱時間 - 70%",
    0
],
```

## itemset.dat.js

セット効果のリレーションは itemset.dat.js で定義されている

```
[
    4993,   # セット効果の itemID
    4992,   # セット効果のベースになる itemID
    -2311   # セット効果のトリガーになる itemID を負数で指定する
],
```
